<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakimi Wallpaper - Pro Billing (Fixed Layout)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { 
            --primary: #2c3e50; 
            --accent: #3498db;
            --bg: #f4f7f6; 
            --border: #dde1e7;
        }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            padding: 10px; 
            margin: 0; 
            color: #333;
            -webkit-font-smoothing: antialiased;
        }

        .container { 
            max-width: 1400px; 
            margin: auto; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05); 
        }

        /* --- HEADER --- */
        .header { 
            text-align: center; 
            border-bottom: 3px solid var(--primary); 
            padding-bottom: 15px; 
            margin-bottom: 25px; 
        }
        .header h1 { margin: 0; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
        .header p { margin: 5px 0 0; color: #666; font-size: 14px; }

        /* --- CUSTOMER INFO --- */
        .customer-section { 
            background: #eef2f5; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            border-left: 5px solid var(--accent); 
        }
        .info-group { margin-bottom: 15px; }
        .info-group label { display: block; font-weight: 700; font-size: 13px; color: #555; margin-bottom: 5px; }
        .info-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            font-size: 16px; 
            box-sizing: border-box; 
            background: white;
        }

        /* --- TABLE STYLES --- */
        .table-wrapper { width: 100%; overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        
        th { 
            background: var(--primary); 
            color: white; 
            padding: 12px 8px; 
            text-transform: uppercase; 
            font-size: 12px; 
            letter-spacing: 0.5px;
            border: 1px solid #1a252f;
        }
        
        td { border: 1px solid var(--border); padding: 8px 5px; text-align: center; vertical-align: middle; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        
        /* INPUTS IN TABLE */
        input, select { 
            width: 90%; 
            padding: 8px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            text-align: center; 
            font-size: 14px;
        }
        input:focus, select:focus { outline: 2px solid var(--accent); border-color: var(--accent); }
        .auto-field { background: #e3f2fd !important; font-weight: bold; color: var(--primary); border: 1px solid #90caf9 !important; }
        
        /* CHECKBOX */
        .aster-wrapper { display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 12px; font-weight: bold; }
        input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

        /* --- BUTTONS --- */
        .controls { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
        button { 
            width: 100%; 
            padding: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            border-radius: 8px; 
            border: none; 
            font-size: 16px; 
            color: white; 
            transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:active { transform: scale(0.98); box-shadow: none; }
        
        .btn-add { background: #27ae60; }
        .btn-pdf { background: #2980b9; }
        .btn-wa { background: #25D366; }

        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 4px; font-size: 18px; margin: 0 2px; }
        .btn-copy { background: #17a2b8; }
        .btn-del { background: #e74c3c; }

        /* --- SUMMARY BOXES (The Fix) --- */
        .summary-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); 
            gap: 25px; 
            margin-top: 30px; 
        }
        .summary-box { 
            background: #fff; 
            border: 1px solid var(--border); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 20px; 
            border-radius: 10px; 
        }
        .summary-box h3 { 
            margin: 0 0 15px 0; 
            color: var(--primary); 
            border-bottom: 2px solid #f1c40f; 
            padding-bottom: 8px; 
            font-size: 18px; 
        }
        
        .summary-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f1f1; font-size: 14px; color: #555; }
        .summary-row strong { color: #000; font-weight: 700; }
        
        .grand-total { 
            font-size: 1.6em; 
            color: var(--primary); 
            font-weight: 800; 
            border-top: 2px solid #333; 
            margin-top: 15px; 
            padding-top: 15px; 
        }

        /* --- MOBILE LAYOUT (Card View) --- */
        @media screen and (max-width: 1000px) {
            thead { display: none; }
            .item-row { 
                display: block; 
                background: white; 
                border: 2px solid #e9ecef; 
                margin-bottom: 20px; 
                padding: 15px; 
                border-radius: 12px; 
                box-shadow: 0 4px 8px rgba(0,0,0,0.05); 
            }
            .item-row td { 
                display: flex; 
                justify-content: space-between; 
                align-items: center; 
                border: none; 
                border-bottom: 1px solid #f1f1f1; 
                padding: 10px 0; 
                text-align: right;
            }
            .item-row td:last-child { border-bottom: none; }
            
            /* Labels */
            .item-row td::before { 
                content: attr(data-label); 
                font-weight: 700; 
                color: #7f8c8d; 
                font-size: 12px; 
                text-transform: uppercase; 
                width: 40%; 
                text-align: left; 
            }
            
            .item-row input, .item-row select { width: 55% !important; text-align: right; height: 35px; }
            
            .track-inputs { width: 55%; display: flex; gap: 5px; justify-content: flex-end; }
            .track-inputs input { width: 48% !important; }
            
            .action-cell { flex-direction: row; justify-content: flex-end; gap: 10px; }
            .action-cell::before { display: none; }
            
            /* Buttons */
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>HAKIMI WALLPAPER PUNE</h1>
        <p><strong>Contact: +91 95032 19051</strong></p>
    </div>

    <div class="customer-section">
        <div class="info-group"><label>Customer Name</label><input type="text" id="custName" placeholder="Enter Name" oninput="saveData()"></div>
        <div class="info-group"><label>Phone Number</label><input type="tel" id="custPhone" placeholder="Enter Phone" oninput="saveData()"></div>
        <div class="info-group"><label>Date</label><input type="date" id="currentDate" oninput="saveData()"></div>
        <div class="info-group"><label>Site / Address</label><input type="text" id="custSite" placeholder="Enter Site" oninput="saveData()"></div>
    </div>

    <div class="table-wrapper">
        <table id="mainTable">
            <thead>
                <tr>
                    <th style="width:6%">Act</th>
                    <th style="width:11%">Space</th>
                    <th style="width:10%">Stitch</th>
                    <th style="width:6%">H</th>
                    <th style="width:6%">W</th>
                    <th style="width:6%">P/Sqft</th>
                    <th style="width:12%">Fabric</th>
                    <th style="width:6%">Aster</th>
                    <th style="width:14%">Track (Name & Rate)</th>
                    <th style="width:6%">Mtr</th>
                    <th style="width:7%">Rate</th>
                    <th style="width:6%">Disc%</th>
                    <th style="width:8%">Total</th>
                </tr>
            </thead>
            <tbody id="items"></tbody>
        </table>
        <div id="emptyMsg" style="text-align:center; padding:20px; color:#999; display:none;">Click "+ Add Item" to start</div>
    </div>

    <div class="controls">
        <button class="btn-add" onclick="addRow()">+ Add New Item</button>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn-pdf" onclick="generatePDF()">üìÑ Download PDF</button>
            <button class="btn-wa" onclick="openWA()">üí¨ WhatsApp</button>
        </div>
    </div>

    <div class="summary-grid">
        
        <div class="summary-box">
            <h3>Box 1: Product Summary</h3>
            <div class="summary-row"><span>Total Fabric:</span> <strong id="summ_fabric">0.00</strong></div>
            <div class="summary-row"><span>Roman (<span id="summ_roman_sqft">0</span> Sqft):</span> <strong id="summ_roman_cost">0.00</strong></div>
            <div class="summary-row"><span>Roller/Zebra:</span> <strong id="summ_roller">0.00</strong></div>
            <div class="summary-row"><span>Tailoring:</span> <strong id="summ_tailor">0.00</strong></div>
            <div class="summary-row"><span>Aster (Lining):</span> <strong id="summ_aster">0.00</strong></div>
            
            <div class="summary-row" style="background:#f0f9ff; padding:10px; margin-top:10px; border:1px solid #bae6fd;">
                <span style="color:var(--primary); font-weight:800;">Product Total:</span> 
                <strong id="box1Total" style="font-size:1.2em;">0.00</strong>
            </div>
            
            <div class="summary-row" style="margin-top:15px; align-items:center;">
                <span>Advance Paid:</span> 
                <input type="number" id="advance" oninput="calculateAll()" value="0" style="width:100px; text-align:right;">
            </div>
            <div class="summary-row" style="color:#c0392b; border:none; padding-top:10px;">
                <span style="font-size:1.2em; font-weight:800;">Balance Due:</span> 
                <strong id="balance" style="font-size:1.4em;">0.00</strong>
            </div>
        </div>

        <div class="summary-box">
            <h3>Box 2: Services & Hardware</h3>
            <div class="summary-row"><span>Hardware (Track/Rod):</span> <strong id="summ_hardware">0.00</strong></div>
            <div class="summary-row"><span>Installation (<span id="summ_items">0</span> Items):</span> <strong id="summ_install">0.00</strong></div>
            <div class="summary-row"><span>Local Transport:</span> <strong>300.00</strong></div>
            
            <div class="summary-row" style="background:#f0f9ff; padding:10px; margin-top:10px; border:1px solid #bae6fd;">
                <span style="color:var(--primary); font-weight:800;">Services Total:</span> 
                <strong id="box2Total" style="font-size:1.2em;">0.00</strong>
            </div>

            <div class="summary-row grand-total">
                <span>GRAND TOTAL:</span> <span id="grandTotal">0.00</span>
            </div>
        </div>

    </div>
</div>

<script>
    document.getElementById('currentDate').valueAsDate = new Date();

    // --- AUTO LOAD DATA ---
    window.addEventListener('load', function() {
        if(localStorage.getItem('hakimi_final_v9')) {
            const saved = JSON.parse(localStorage.getItem('hakimi_final_v9'));
            document.getElementById('custName').value = saved.custName || '';
            document.getElementById('custPhone').value = saved.custPhone || '';
            document.getElementById('custSite').value = saved.custSite || '';
            document.getElementById('advance').value = saved.advance || 0;
            
            if(saved.rows && saved.rows.length > 0) {
                saved.rows.forEach(r => addRow(r));
            } else {
                addRow();
            }
        } else {
            addRow(); 
        }
    });

    function saveData() {
        const rows = [];
        document.querySelectorAll('.item-row').forEach(row => {
            rows.push({
                space: row.querySelector('.space-sel').value,
                stitch: row.querySelector('.stitch-sel').value,
                h: row.querySelector('.val-h').value,
                w: row.querySelector('.val-w').value,
                fabric: row.querySelector('.val-fabric').value,
                aster: row.querySelector('.aster-check').checked,
                trackName: row.querySelector('.track-name').value,
                trackRate: row.querySelector('.track-rate').value,
                rate: row.querySelector('.rate').value,
                disc: row.querySelector('.disc').value
            });
        });

        localStorage.setItem('hakimi_final_v9', JSON.stringify({
            custName: document.getElementById('custName').value,
            custPhone: document.getElementById('custPhone').value,
            custSite: document.getElementById('custSite').value,
            advance: document.getElementById('advance').value,
            rows: rows
        }));
    }

    // --- HTML ROW GENERATOR ---
    function createRowHTML(data = {}) {
        return `
            <td data-label="Actions" class="action-cell">
                <button class="btn-icon btn-copy" onclick="cloneRow(this)">üìÑ</button>
                <button class="btn-icon btn-del" onclick="removeRow(this)">üóëÔ∏è</button>
            </td>
            <td data-label="Space">
                <select class="space-sel" onchange="saveData()">
                    <option ${data.space=='Living room'?'selected':''}>Living room</option>
                    <option ${data.space=='Master bedroom'?'selected':''}>Master bedroom</option>
                    <option ${data.space=='Kids bedroom'?'selected':''}>Kids bedroom</option>
                    <option ${data.space=='Bedroom'?'selected':''}>Bedroom</option>
                    <option ${data.space=='Guest room'?'selected':''}>Guest room</option>
                    <option ${data.space=='Office'?'selected':''}>Office</option>
                    <option ${data.space=='Other'?'selected':''}>Other</option>
                </select>
            </td>
            <td data-label="Stitch">
                <select class="stitch-sel" onchange="calculateAll()">
                    <option value="none" ${data.stitch=='none'?'selected':''}>Select</option>
                    <option value="american" ${data.stitch=='american'?'selected':''}>American</option>
                    <option value="roman" ${data.stitch=='roman'?'selected':''}>Roman</option>
                    <option value="french" ${data.stitch=='french'?'selected':''}>French</option>
                    <option value="ring" ${data.stitch=='ring'?'selected':''}>Ring</option>
                    <option value="roller" ${data.stitch=='roller'?'selected':''}>Roller/Zebra</option>
                </select>
            </td>
            <td data-label="Height"><input type="number" class="val-h" oninput="calculateAll()" value="${data.h||''}" placeholder="H"></td>
            <td data-label="Width"><input type="number" class="val-w" oninput="calculateAll()" value="${data.w||''}" placeholder="W"></td>
            <td data-label="P / Sqft"><input type="number" class="val-p auto-field" readonly value="${data.p||''}"></td>
            
            <td data-label="Fabric"><input type="text" class="val-fabric" value="${data.fabric||''}" placeholder="Name" oninput="saveData()"></td>
            
            <td data-label="Aster (Lining)">
                <div class="aster-wrapper">
                    <input type="checkbox" class="aster-check" onchange="calculateAll()" ${data.aster?'checked':''}>
                    <span>Add</span>
                </div>
            </td>

            <td data-label="Track (Name & Rate)">
                <div class="track-inputs" style="display:flex; gap:5px;">
                    <input type="text" class="track-name" placeholder="Name" value="${data.trackName||''}" oninput="saveData()">
                    <input type="number" class="track-rate" placeholder="Rate" value="${data.trackRate||''}" oninput="calculateAll()">
                </div>
            </td>
            
            <td data-label="Mtr"><input type="number" class="mtr auto-field" readonly value="${data.mtr||''}"></td>
            <td data-label="Rate"><input type="number" class="rate" oninput="calculateAll()" value="${data.rate||''}"></td>
            <td data-label="Disc %"><input type="number" class="disc" oninput="calculateAll()" value="${data.disc||''}" placeholder="%"></td>
            <td data-label="Total"><strong><span class="rowTotal">${data.total||'0.00'}</span></strong></td>
        `;
    }

    function addRow(data) {
        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.innerHTML = createRowHTML(data);
        document.getElementById('items').appendChild(tr);
        document.getElementById('emptyMsg').style.display = 'none';
        calculateAll();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        calculateAll();
    }

    function cloneRow(btn) {
        const row = btn.closest('tr');
        const data = {
            space: row.querySelector('.space-sel').value,
            stitch: row.querySelector('.stitch-sel').value,
            h: row.querySelector('.val-h').value,
            w: row.querySelector('.val-w').value,
            fabric: "", 
            rate: "",
            trackName: row.querySelector('.track-name').value,
            trackRate: row.querySelector('.track-rate').value,
            disc: row.querySelector('.disc').value,
            aster: row.querySelector('.aster-check').checked
        };
        addRow(data);
    }

    // --- MAIN CALCULATION LOGIC ---
    function calculateAll() {
        let fabCost=0, romanCost=0, rollerCost=0, tailorCost=0, asterCost=0, hwCost=0;
        let romanSqft=0, itemCount=0;

        document.querySelectorAll('.item-row').forEach(row => {
            const stitch = row.querySelector('.stitch-sel').value;
            const h = parseFloat(row.querySelector('.val-h').value) || 0;
            const w = parseFloat(row.querySelector('.val-w').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const disc = parseFloat(row.querySelector('.disc').value) || 0;
            const trackRate = parseFloat(row.querySelector('.track-rate').value) || 0;
            const aster = row.querySelector('.aster-check').checked;
            
            itemCount++;
            let p=0, mtr=0, rowTot=0, sqft=0;

            if (h>0 && w>0) {
                // Round Sqft
                sqft = Math.ceil((h*w)/144);

                if (stitch === 'american') p = Math.ceil(w/24);
                else if (stitch === 'roman') p = Math.ceil(w/46);
                else if (stitch === 'french') p = Math.ceil(w/19);
                else if (stitch === 'ring') p = Math.ceil(w/30);
                
                if (stitch === 'roman') {
            
