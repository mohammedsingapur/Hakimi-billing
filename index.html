<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hakimi Billing - Final Summary Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 10px; margin: 0; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Header */
        .header { text-align: center; border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 22px; text-transform: uppercase; }
        
        /* Customer Info */
        .customer-section { background: #eef2f5; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid var(--accent); }
        .info-group { margin-bottom: 10px; }
        .info-group label { display: block; font-weight: bold; font-size: 12px; color: #555; margin-bottom: 4px; }
        .info-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        /* Table */
        .table-wrapper { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 13px; min-width: 1000px; }
        th { background: var(--primary); color: white; padding: 10px 5px; font-size: 11px; text-transform: uppercase; }
        td { border-bottom: 1px solid #ddd; padding: 8px 4px; text-align: center; }
        input, select { width: 90%; padding: 6px; border: 1px solid #ccc; text-align: center; }
        .auto-field { background: #e3f2fd; font-weight: bold; border: none; }

        /* Summary Boxes (The Fix) */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .summary-box { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .summary-box h3 { margin: 0 0 10px 0; color: var(--primary); border-bottom: 2px solid #f1c40f; padding-bottom: 5px; font-size: 16px; }
        .summary-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .summary-row strong { color: #000; }
        
        .grand-total { font-size: 1.4em; color: var(--primary); font-weight: 800; border-top: 2px solid #333; margin-top: 10px; padding-top: 10px; }

        /* Mobile Adjustments */
        @media screen and (max-width: 1000px) {
            thead { display: none; }
            .item-row { display: block; background: white; border: 2px solid #eee; margin-bottom: 15px; padding: 10px; border-radius: 8px; }
            .item-row td { display: flex; justify-content: space-between; align-items: center; border: none; border-bottom: 1px solid #eee; }
            .item-row td::before { content: attr(data-label); font-weight: bold; color: #777; font-size: 11px; }
            .item-row input, .item-row select { width: 55%; text-align: right; }
        }

        /* Buttons */
        .controls { display: flex; gap: 10px; margin: 20px 0; }
        button { flex: 1; padding: 12px; font-weight: bold; border-radius: 6px; border: none; color: white; cursor: pointer; }
        .btn-add { background: #27ae60; } .btn-pdf { background: #2980b9; } .btn-wa { background: #25D366; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>HAKIMI WALLPAPER PUNE</h1>
        <p>Contact: +91 95032 19051</p>
    </div>

    <div class="customer-section">
        <div class="info-group"><label>Customer Name</label><input type="text" id="custName" placeholder="Enter Name"></div>
        <div class="info-group"><label>Phone Number</label><input type="tel" id="custPhone" placeholder="Enter Phone"></div>
        <div class="info-group"><label>Date</label><input type="date" id="currentDate"></div>
        <div class="info-group"><label>Site / Address</label><input type="text" id="custSite" placeholder="Enter Site"></div>
    </div>

    <div class="table-wrapper">
        <table id="mainTable">
            <thead>
                <tr>
                    <th style="width:5%">Act</th>
                    <th style="width:12%">Space</th><th style="width:10%">Stitch</th>
                    <th style="width:6%">H</th><th style="width:6%">W</th>
                    <th style="width:6%">P/Sqft</th><th style="width:12%">Fabric</th>
                    <th style="width:5%">Aster</th><th style="width:12%">Hardware</th>
                    <th style="width:6%">Mtr</th><th style="width:7%">Rate</th>
                    <th style="width:6%">Disc%</th><th style="width:7%">Total</th>
                </tr>
            </thead>
            <tbody id="items"></tbody>
        </table>
    </div>

    <div class="controls">
        <button class="btn-add" onclick="addRow()">+ Add Item</button>
        <button class="btn-pdf" onclick="generatePDF()">Download PDF</button>
        <button class="btn-wa" onclick="openWA()">WhatsApp</button>
    </div>

    <div class="summary-grid">
        
        <div class="summary-box">
            <h3>Box 1: Product Summary</h3>
            <div class="summary-row"><span>Total Fabric:</span> <span id="summ_fabric">0.00</span></div>
            <div class="summary-row"><span>Roman (<span id="summ_roman_sqft">0</span> Sqft):</span> <span id="summ_roman_cost">0.00</span></div>
            <div class="summary-row"><span>Roller/Zebra:</span> <span id="summ_roller">0.00</span></div>
            <div class="summary-row"><span>Tailoring:</span> <span id="summ_tailor">0.00</span></div>
            <div class="summary-row"><span>Aster (Lining):</span> <span id="summ_aster">0.00</span></div>
            
            <div class="summary-row" style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px; font-weight:bold; color:#2c3e50;">
                <span>Product Total:</span> <span id="box1Total">0.00</span>
            </div>
            
            <div class="summary-row" style="margin-top:15px; align-items:center;">
                <span>Advance Paid:</span> 
                <input type="number" id="advance" oninput="calculateAll()" value="0" style="width:80px; text-align:right;">
            </div>
            <div class="summary-row" style="color:#c0392b; font-weight:bold;">
                <span>Balance Due:</span> <span id="balance">0.00</span>
            </div>
        </div>

        <div class="summary-box">
            <h3>Box 2: Services & Hardware</h3>
            <div class="summary-row"><span>Hardware (Track/Rod):</span> <span id="summ_hardware">0.00</span></div>
            <div class="summary-row"><span>Installation (<span id="summ_items">0</span> Items x 250):</span> <span id="summ_install">0.00</span></div>
            <div class="summary-row"><span>Local Transport:</span> <span>300.00</span></div>
            
            <div class="summary-row" style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px; font-weight:bold; color:#2c3e50;">
                <span>Services Total:</span> <span id="box2Total">0.00</span>
            </div>

            <div class="summary-row grand-total">
                <span>GRAND TOTAL:</span> <span id="grandTotal">0.00</span>
            </div>
        </div>

    </div>
</div>

<script>
    document.getElementById('currentDate').valueAsDate = new Date();

    // --- AUTO LOAD ---
    window.onload = function() {
        if(localStorage.getItem('hakimi_v8')) {
            const saved = JSON.parse(localStorage.getItem('hakimi_v8'));
            document.getElementById('custName').value = saved.custName || '';
            document.getElementById('custPhone').value = saved.custPhone || '';
            document.getElementById('custSite').value = saved.custSite || '';
            document.getElementById('advance').value = saved.advance || 0;
            if(saved.rows && saved.rows.length > 0) saved.rows.forEach(r => addRow(r));
            else addRow();
        } else { addRow(); }
    };

    function saveData() {
        const rows = [];
        document.querySelectorAll('.item-row').forEach(row => {
            rows.push({
                space: row.querySelector('.space-sel').value,
                stitch: row.querySelector('.stitch-sel').value,
                h: row.querySelector('.val-h').value,
                w: row.querySelector('.val-w').value,
                fabric: row.querySelector('.val-fabric').value,
                aster: row.querySelector('.aster-check').checked,
                trackName: row.querySelector('.track-name').value,
                trackRate: row.querySelector('.track-rate').value,
                rate: row.querySelector('.rate').value,
                disc: row.querySelector('.disc').value
            });
        });
        localStorage.setItem('hakimi_v8', JSON.stringify({
            custName: document.getElementById('custName').value,
            custPhone: document.getElementById('custPhone').value,
            custSite: document.getElementById('custSite').value,
            advance: document.getElementById('advance').value,
            rows: rows
        }));
    }

    function createRowHTML(data = {}) {
        return `
            <td data-label="Act">
                <button style="background:#e74c3c; padding:5px;" onclick="this.closest('tr').remove(); calculateAll();">üóëÔ∏è</button>
            </td>
            <td data-label="Space">
                <select class="space-sel" onchange="saveData()">
                    <option ${data.space=='Living room'?'selected':''}>Living room</option>
                    <option ${data.space=='Master bedroom'?'selected':''}>Master bedroom</option>
                    <option ${data.space=='Kids bedroom'?'selected':''}>Kids bedroom</option>
                    <option ${data.space=='Guest room'?'selected':''}>Guest room</option>
                    <option ${data.space=='Other'?'selected':''}>Other</option>
                </select>
            </td>
            <td data-label="Stitch">
                <select class="stitch-sel" onchange="calculateAll()">
                    <option value="none" ${data.stitch=='none'?'selected':''}>Select</option>
                    <option value="american" ${data.stitch=='american'?'selected':''}>American</option>
                    <option value="roman" ${data.stitch=='roman'?'selected':''}>Roman</option>
                    <option value="roller" ${data.stitch=='roller'?'selected':''}>Roller/Zebra</option>
                </select>
            </td>
            <td data-label="H"><input type="number" class="val-h" oninput="calculateAll()" value="${data.h||''}"></td>
            <td data-label="W"><input type="number" class="val-w" oninput="calculateAll()" value="${data.w||''}"></td>
            <td data-label="P/Sqft"><input type="number" class="val-p auto-field" readonly value="${data.p||''}"></td>
            <td data-label="Fabric"><input type="text" class="val-fabric" value="${data.fabric||''}" oninput="saveData()"></td>
            
            <td data-label="Aster">
                <input type="checkbox" class="aster-check" onchange="calculateAll()" ${data.aster?'checked':''}>
            </td>

            <td data-label="Hardware">
                <div style="display:flex; gap:2px;">
                    <input type="text" class="track-name" placeholder="Name" value="${data.trackName||''}" oninput="saveData()">
                    <input type="number" class="track-rate" placeholder="Rate" value="${data.trackRate||''}" oninput="calculateAll()">
                </div>
            </td>
            
            <td data-label="Mtr"><input type="number" class="mtr auto-field" readonly value="${data.mtr||''}"></td>
            <td data-label="Rate"><input type="number" class="rate" oninput="calculateAll()" value="${data.rate||''}"></td>
            <td data-label="Disc%"><input type="number" class="disc" oninput="calculateAll()" value="${data.disc||''}"></td>
            <td data-label="Total"><strong><span class="rowTotal">${data.total||'0.00'}</span></strong></td>
        `;
    }

    function addRow(data) {
        const tr = document.createElement('tr');
        tr.className = 'item-row';
        tr.innerHTML = createRowHTML(data);
        document.getElementById('items').appendChild(tr);
        calculateAll();
    }

    // --- CALCULATIONS ---
    function calculateAll() {
        let fabCost=0, romanCost=0, rollerCost=0, tailorCost=0, asterCost=0, hwCost=0;
        let romanSqft=0, itemCount=0;

        document.querySelectorAll('.item-row').forEach(row => {
            itemCount++;
            const stitch = row.querySelector('.stitch-sel').value;
            const h = parseFloat(row.querySelector('.val-h').value) || 0;
            const w = parseFloat(row.querySelector('.val-w').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const disc = parseFloat(row.querySelector('.disc').value) || 0;
            const trackRate = parseFloat(row.querySelector('.track-rate').value) || 0;
            const aster = row.querySelector('.aster-check').checked;
            
            let p=0, mtr=0, rowTot=0, sqft=Math.ceil((h*w)/144);

            if (h>0 && w>0) {
                if (stitch === 'american') p = Math.ceil(w/24);
                else if (stitch === 'roman') p = Math.ceil(w/46);
                
                if (stitch === 'roman') {
                    mtr = Math.ceil(((h+15)/39)*p);
                    rowTot = (mtr*rate) * (1 - disc/100);
                    romanSqft += sqft;
                    romanCost += (sqft * 160); 
                } 
                else if (stitch === 'roller') {
                    p = Math.ceil(Math.max(11, ((h+6)*w)/144)); 
                    rowTot = (p*rate) * (1 - disc/100);
                    rollerCost += rowTot; 
                } 
                else if (stitch !== 'none') { // American, etc
                    mtr = Math.ceil(((h+15)/39)*p);
                    rowTot = (mtr*rate) * (1 - disc/100);
                    tailorCost += (p * 150); 
                }
            }

            row.querySelector('.val-p').value = p.toFixed(2);
            row.querySelector('.mtr').value = mtr.toFixed(2);
            row.querySelector('.rowTotal').innerText = rowTot.toFixed(2);

            if(stitch !== 'roller') fabCost += rowTot;
            if(aster && mtr > 0) asterCost += (mtr * 200);
            if(trackRate > 0) hwCost += (Math.ceil(w/12) * trackRate);
        });

        // Box 1
        document.getElementById('summ_fabric').innerText = fabCost.toFixed(2);
        document.getElementById('summ_roman_sqft').innerText = romanSqft.toFixed(0);
        document.getElementById('summ_roman_cost').innerText = romanCost.toFixed(2);
        document.getElementById('summ_roller').innerText = rollerCost.toFixed(2);
        document.getElementById('summ_tailor').innerText = tailorCost.toFixed(2);
        document.getElementById('summ_aster').innerText = asterCost.toFixed(2);
        let box1 = fabCost + romanCost + rollerCost + tailorCost + asterCost;
        document.getElementById('box1Total').innerText = box1.toFixed(2);

        // Box 2
        let installCost = itemCount * 250;
        let transport = 300;
        document.getElementById('summ_hardware').innerText = hwCost.toFixed(2);
        document.getElementById('summ_items').innerText = itemCount;
        document.getElementById('summ_install').innerText = installCost.toFixed(2);
        let box2 = hwCost + installCost + transport;
        document.getElementById('box2Total').innerText = box2.toFixed(2);

        // Totals
        let grand = box1 + box2;
        document.getElementById('grandTotal').innerText = grand.toFixed(2);
        let adv = parseFloat(document.getElementById('advance').value) || 0;
        document.getElementById('balance').innerText = (grand - adv).toFixed(2);
        
        saveData();
    }

    function openWA() {
        let phone = document.getElementById('custPhone').value;
        let grand = document.getElementById('grandTotal').innerText;
        window.open(`https://wa.me/91${phone}?text=Quotation Total: ‚Çπ${grand}`, '_blank');
    }

    // --- PDF GENERATION (FIXED BOXES) ---
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4'); 
        
        doc.setFillColor(44, 62, 80); doc.rect(0, 0, 595, 80, 'F');
        doc.setFontSize(22); doc.setTextColor(255); doc.text("HAKIMI WALLPAPER PUNE", 297, 45, { align: "center" });
        doc.setFontSize(10); doc.text("Contact: +91 95032 19051", 297, 65, { align: "center" });

        // Customer
        doc.setTextColor(0); doc.text(`Customer: ${document.getElementById('custName').value}`, 40, 100);
        doc.text(`Date: ${document.getElementById('currentDate').value}`, 400, 100);

        // Table
        const body = [];
        document.querySelectorAll('.item-row').forEach(row => {
            let space = row.querySelector('.space-sel').value;
            let fab = row.querySelector('.val-fabric').value;
            let size = `${row.querySelector('.val-h').value}" x ${row.querySelector('.val-w').value}"`;
            let track = row.querySelector('.track-rate').value > 0 ? row.querySelector('.track-name').value : '-';
            let mtr = row.querySelector('.mtr').value;
            let total = row.querySelector('.rowTotal').innerText;
            body.push([space, size, fab, track, mtr, total]);
        });

        doc.autoTable({
            startY: 120,
            head: [['Room', 'Size', 'Fabric', 'Hardware', 'Mtr', 'Total']],
            body: body,
            theme: 'striped',
            headStyles: { fillColor: [44, 62, 80] }
        });

        // DRAW BOXES
        let y = doc.lastAutoTable.finalY + 20;
        if(y > 650) { doc.addPage(); y = 40; }

        // Box 1 (Product) - Left
        doc.setDrawColor(0); doc.rect(40, y, 250, 130);
        doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text("Box 1: Product", 50, y+20);
        doc.setFontSize(9); doc.setFont(undefined, 'normal');
        doc.text(`Fabric: ${document.getElementById('summ_fabric').innerText}`, 50, y+40);
        doc.text(`Roman Making: ${document.getElementById('summ_roman_cost').innerText}`, 50, y+55);
        doc.text(`Roller: ${document.getElementById('summ_roller').innerText}`, 50, y+70);
        doc.text(`Tailoring: ${document.getElementById('summ_tailor').innerText}`, 50, y+85);
        doc.text(`Aster: ${document.getElementById('summ_aster').innerText}`, 50, y+100);
        doc.setFont(undefined, 'bold');
        doc.text(`Total: ${document.getElementById('box1Total').innerText}`, 50, y+120);

        // Box 2 (Services) - Right
        doc.rect(300, y, 250, 130);
        doc.text("Box 2: Services", 310, y+20);
        doc.setFont(undefined, 'normal');
        doc.text(`Hardware: ${document.getElementById('summ_hardware').innerText}`, 310, y+40);
        doc.text(`Installation: ${document.getElementById('summ_install').innerText}`, 310, y+55);
        doc.text(`Transport: 300.00`, 310, y+70);
        doc.setFont(undefined, 'bold');
        doc.text(`Total: ${document.getElementById('box2Total').innerText}`, 310, y+90);

        // Grand Total
        doc.setFontSize(14); doc.text(`GRAND TOTAL: ${document.getElementById('grandTotal').innerText}`, 310, y+120);

        doc.save('quotation.pdf');
    }
</script>
</body>
</html>
